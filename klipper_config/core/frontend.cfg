[gcode_macro _PROMPT_SELECT_SETTINGS_SOURCE]
gcode:
## load settings db or throw error if save variable not set
    {% set fs_table=printer.save_variables.variables['kbobine_table'] | default({}) %}

## load variables
    {% set kb_vars = printer.vars.KBOBINE %}
    {% set ID = params['ID']|default(0)|int %}
## variables declaration    
    {% set same_filament = {} %}

## Check for equivalent filament
    {% if ID %}
        ## Same vendor, name, material
        {% for k, v in fs_table.items() 
            if v.vendor == kb_vars.spoolman.vendor 
                and v.name == kb_vars.spoolman.name
                and v.material == kb_vars.spoolman.material %}
            {% set _=same_filament.update({k:v}) %}
        {% endfor %}
        ## or same vendor, material    
        {% if same_filament|length == 0 %}
        {% for k, v in fs_table.items() 
            if v.vendor == kb_vars.spoolman.vendor 
                and v.material == kb_vars.spoolman.material %}
            {% set _=same_filament.update({k:v}) %}
        {% endfor %}
        {% endif %}
        ## or same material only
        {% if same_filament|length == 0 %}
        {% for k, v in fs_table.items() 
            if v.material == kb_vars.spoolman.material %}
            {% set _=same_filament.update({k:v}) %}
        {% endfor %}
        {% endif %}

 ## Prompt_ui       
        RESPOND TYPE=command MSG="action:prompt_begin Insert new filament"
        RESPOND TYPE=command MSG="action:prompt_text There is no settings for '{ID}:{
                kb_vars.spoolman.vendor|upper} {
                kb_vars.spoolman.name|upper}'.{
                " Duplicate setttings from :" if same_filament|length > 0 else ''}"
        {% for SOURCE, settings in same_filament.items()|sort(reverse=True) %}
            RESPOND TYPE=command MSG="action:prompt_button {SOURCE}:{settings.vendor} {
                settings.name}|_INSERT_FILAMENT_SETTINGS SOURCE={SOURCE}"
        {% endfor %}
        RESPOND TYPE=command MSG="action:prompt_button Use default|_INSERT_FILAMENT_SETTINGS ID={ID}|primary"
        RESPOND TYPE=command MSG="action:prompt_footer_button Abort|_PROMPT_CLOSE|error"
        RESPOND TYPE=command MSG="action:prompt_show"   
    {% endif %}

[gcode_macro _PROMPT_QUESTION]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin {params.TITLE|default("Filament settings")}"
    RESPOND TYPE=command MSG="action:prompt_text {params.MSG}"
    RESPOND TYPE=command MSG="action:prompt_footer_button Yes|{params.ACTION}"
    RESPOND TYPE=command MSG="action:prompt_footer_button No|_PROMPT_CLOSE|error"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _PROMPT_MSGBOX]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin {params.TITLE|default("Filament settings")}"
    RESPOND TYPE=command MSG="action:prompt_text {params.MSG}"
    RESPOND TYPE=command MSG="action:prompt_footer_button OK|_PROMPT_CLOSE|error"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _PROMPT_CALIBRATE]
gcode:
    {% if printer['gcode_macro CALIBRATE'] %}
    _PROMPT_QUESTION TITLE="{params.TITLE|default("Filament calibration")}" MSG="{params.REASON|default('')
            }Filament calibration required. Run it now ?" ACTION="CALIBRATE"
    {% else %}
    _PROMPT_MSGBOX TITLE="{params.TITLE|default("Filament calibration")}" MSG="{params.REASON|default('')
            }Filament calibration required."
    {% endif %}

[gcode_macro _PROMPT_CLOSE]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
