[vars KBOBINE]
fan_speed_enabled : True
fan_speed: {'value': 1.0,
            'cur_speed': 0.0}

[gcode_macro SET_PARTFAN]
description: Use instead of M106 in slicer
gcode:
    {% set kb_vars=printer.vars.KBOBINE %}
    {% set fan_speed=kb_vars.fan_speed %}
    {% set fan_config = printer.configfile.config.fan %}
    {% set S = params['S']|default(0)|float %}

    {% if kb_vars.fan_speed_enabled and S %}
        {% set _= fan_speed.update({'cur_speed' : S}) %}
        SET_VARS_KBOBINE FAN_SPEED='{fan_speed|tojson}'
        {% set s = S*fan_speed.value %}
        M106 S{s|int}  
    {% else %}
        M106 S{S}
    {%endif%}

[gcode_macro _KBOBINE_FAN_SPEED]
description: Apply Fan Speed
gcode:
    {% set S=params.S|default(0)|float %}
    {% set fan_speed=printer.vars.KBOBINE.fan_speed %}
    {% if S %}
        {% set _= fan_speed.update({'value' : S,
                'cur_speed' : printer.fan.speed / fan_speed.value * 255,
                }) %}
        SET_VARS_KBOBINE FAN_SPEED='{ fan_speed|tojson }'
        SET_PARTFAN S={fan_speed.cur_speed}
    {%endif%}